{{/* Increment a page-level counter to ensure unique IDs for multiple tabsets */}}
{{ .Page.Scratch.Add "tabset-counter" 1 }}

{{/* Generate a unique ID for this tabset, using a provided name or creating one */}}
{{ $tab_set_id := .Get "name" | default (printf "tabset-%s-%d" (.Page.RelPermalink) (.Page.Scratch.Get "tabset-counter")) | anchorize }}

{{/* Retrieve the tab data collected by the child 'tab' shortcodes */}}
{{ $tabs := .Scratch.Get "tabs" }}

{{/* This is crucial: we must reference .Inner for Hugo to process the nested 'tab' shortcodes */}}
{{ .Inner }}

{{ if $tabs }}
<div class="tabs-container" id="{{ $tab_set_id }}">
  <ul class="tabs-nav">
    {{ range $i, $e := $tabs }}
    <li class="tab-nav-item">
      <a href="#tab-{{ $tab_set_id }}-{{ $i }}" class="tab-nav-link{{ if eq $i 0 }} active{{ end }}">
        {{ .name | trim " " }}
      </a>
    </li>
    {{ end }}
  </ul>
  <div class="tabs-content">
    {{ range $i, $e := $tabs }}
    <div id="tab-{{ $tab_set_id }}-{{ $i }}" class="tab-panel{{ if eq $i 0 }} active{{ end }}">
      {{/* Case 1: Content was provided directly via .Inner in the child tab */}}
      {{ with .content }}
      {{ . }}
      {{ else }}
      {{/* Case 2: Content must be included from a file */}}
      {{ $includePath := .include }}
      {{ $codelang := .codelang }}
      {{ $content := "" }}

      {{/* Method A: Find the file within a Leaf Bundle */}}
      {{ if eq $.Page.BundleType "leaf" }}
      {{ with $.Page.Resources.GetMatch (printf "**%s*" $includePath) }}
      {{ $content = .Content }}
      {{ if and (ne .ResourceType "page") $codelang }}
      {{ $lang := $codelang | default (path.Ext .Name | strings.TrimPrefix ".") }}
      {{ $content = highlight .Content $lang "" }}
      {{ end }}
      {{ end }}
      {{ else }}
      {{/* Method B: Find the file relative to the current page's directory */}}
      {{ $path := path.Join $.Page.Dir $includePath }}
      {{ with $.Page.Site.GetPage $path }}
      {{ $content = .Content }}
      {{ else }}
      {{ errorf "The 'tabs' shortcode could not find the include file at path: %s" $path }}
      {{ end }}
      {{ end }}
      {{ $content }}
      {{ end }}
    </div>
    {{ end }}
  </div>
</div>

{{/* VERY IMPORTANT: Clean up the scratchpad after use */}}
{{ .Scratch.Delete "tabs" }}

{{ else }}
{{/* A 'tabs' shortcode was used without any child 'tab' shortcodes inside. */}}
{{ end }}

{{/* Self-contained JavaScript to